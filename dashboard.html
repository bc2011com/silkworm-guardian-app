<!DOCTYPE html>
<html lang="th">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>แดชบอร์ดเกษตรกรเลี้ยงไหม</title>

  <!-- ใส่ <style> หรือ <link rel="stylesheet" ...> ของ Dashboard เดิมได้ตามปกติ -->
  <link rel="stylesheet" href="styles.css" />
</head>
<body>

  <!-- แถบบนแสดงชื่อเกษตรกร / ฟาร์ม + ปุ่มออกจากระบบ (จะใช้ต่อได้เลย) -->
  <section class="dashboard-header">
    <div class="dashboard-card">
      <h2>แดชบอร์ดเกษตรกรเลี้ยงไหม</h2>
      <p>ระบบอารักขารังไหมเลี้ยงอัจฉริยะ</p>

      <div class="farmer-info-box">
        <p>ชื่อเกษตรกร: <span id="farmer-name">กำลังโหลด...</span></p>
        <p>ชื่อฟาร์ม/กลุ่ม: <span id="farm-name">กำลังโหลด...</span></p>
      </div>

      <button id="logout-btn" class="logout-btn">ออกจากระบบ</button>
    </div>
  </section>

  <!-- ==========================
       วาง HTML Dashboard เดิมตรงนี้
       (เวอร์ชันที่เคยสวย ๆ บอกว่าวันที่เท่าไหร่ วัยที่เท่าไหร่ ฯลฯ)
       ========================== -->
  <!-- ตัวอย่าง: 
  <main class="main-dashboard">
    ... โค้ดเดิมของหน้า dashboard เก่า ...
  </main>
  -->

  <!-- สคริปต์เชื่อม Supabase + Auth Guard -->
  <script type="module">
    import { supabase } from "./supabase.js";
    import { requireAuth } from "./auth-guard.js";

    // 1) บังคับให้ต้องล็อกอินก่อน
    const { user } = await requireAuth();

    // 2) ดึงโปรไฟล์จากตาราง profiles
    const { data: profile, error } = await supabase
      .from("profiles")
      .select("full_name, farm_name")
      .eq("user_id", user.id)
      .single();

    const farmerNameEl = document.getElementById("farmer-name");
    const farmNameEl = document.getElementById("farm-name");

    if (error) {
      console.error("โหลดโปรไฟล์ไม่ได้", error);
      farmerNameEl.textContent = "ไม่พบข้อมูล";
      farmNameEl.textContent = "-";
    } else if (profile) {
      farmerNameEl.textContent = profile.full_name || "-";
      farmNameEl.textContent = profile.farm_name || "-";
    }

    // 3) ปุ่มออกจากระบบ
    const logoutBtn = document.getElementById("logout-btn");
    logoutBtn.addEventListener("click", async () => {
      await supabase.auth.signOut();
      window.location.href = "login.html";
    });

    // 4) ถ้าใน Dashboard เดิมมีโค้ด JS คำนวณวัยไหม / ดึงข้อมูล batch ฯลฯ
    //    ให้นำโค้ดเดิมมาวางข้างล่างนี้ แล้วเปลี่ยนให้ filter ด้วย user.id ถ้าจำเป็น เช่น:
    //
    // const { data: activeBatch } = await supabase
    //   .from("silkworm_batches")
    //   .select("*")
    //   .eq("user_id", user.id)
    //   .eq("is_active", true)
    //   .single();
    //
    // แล้วใช้ activeBatch ไปแสดงว่า
    // วันนี้เลี้ยงไหม "วัยที่ X" "วันที่เลี้ยงที่ Y" ฯลฯ
  </script>
</body>
</html>
