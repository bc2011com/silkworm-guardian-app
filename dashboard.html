<!DOCTYPE html>
<html lang="th">
<head>
  <meta charset="UTF-8" />
  <title>‡∏≠‡∏≤‡∏£‡∏±‡∏Å‡∏Ç‡∏≤‡∏£‡∏±‡∏á‡πÑ‡∏´‡∏°‡πÄ‡∏•‡∏µ‡πâ‡∏¢‡∏á‡∏≠‡∏±‡∏à‡∏â‡∏£‡∏¥‡∏¢‡∏∞ - Dashboard</title>
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <style>
    * {
      box-sizing: border-box;
      margin: 0;
      padding: 0;
    }

    body {
      font-family: "Sarabun", -apple-system, BlinkMacSystemFont, "Segoe UI", sans-serif;
      background: #e8f5e9;
      color: #1b5e20;
      min-height: 100vh;
      display: flex;
      flex-direction: column;
      align-items: center;
    }

    .app-shell {
      width: 100%;
      max-width: 480px;
      min-height: 100vh;
      background: #f4fff6;
      box-shadow: 0 0 20px rgba(0,0,0,0.12);
      display: flex;
      flex-direction: column;
    }

    header {
      background: linear-gradient(135deg, #2e7d32, #1b5e20);
      color: #fff;
      padding: 14px 16px 10px;
      display: flex;
      align-items: center;
      justify-content: space-between;
    }

    header .title-block {
      display: flex;
      flex-direction: column;
    }

    header h1 {
      font-size: 18px;
      font-weight: 700;
      display: flex;
      align-items: center;
      gap: 6px;
    }

    header h1 span.icon {
      font-size: 20px;
    }

    header .subtitle {
      font-size: 12px;
      opacity: 0.9;
    }

    header .today-text {
      font-size: 12px;
      text-align: right;
      opacity: 0.9;
    }

    main {
      flex: 1;
      overflow-y: auto;
      padding: 10px 10px 70px;
    }

    .card {
      background: #ffffff;
      border-radius: 18px;
      padding: 12px 14px;
      box-shadow: 0 3px 10px rgba(0,0,0,0.06);
      margin-bottom: 10px;
    }

    .card-header {
      display: flex;
      align-items: center;
      gap: 6px;
      margin-bottom: 6px;
    }

    .card-header-icon {
      width: 26px;
      height: 26px;
      border-radius: 50%;
      background: #e8f5e9;
      display: flex;
      align-items: center;
      justify-content: center;
      font-size: 16px;
    }

    .card-header-title {
      font-size: 15px;
      font-weight: 700;
      color: #1b5e20;
    }

    .card-subtitle {
      font-size: 12px;
      color: #616161;
      margin-bottom: 6px;
    }

    .badge {
      display: inline-block;
      border-radius: 999px;
      font-size: 11px;
      padding: 2px 8px;
      margin-right: 6px;
      margin-top: 2px;
    }

    .badge-green {
      background: #e8f5e9;
      color: #1b5e20;
      border: 1px solid #a5d6a7;
    }

    .badge-orange {
      background: #fff3e0;
      color: #e65100;
      border: 1px solid #ffb74d;
    }

    .badge-blue {
      background: #e3f2fd;
      color: #1e88e5;
      border: 1px solid #90caf9;
    }

    .metrics-grid {
      display: grid;
      grid-template-columns: repeat(2, 1fr);
      gap: 6px;
      margin-top: 6px;
    }

    .metric-box {
      background: #f4f9f5;
      border-radius: 14px;
      padding: 6px 8px;
      border: 1px solid #e0f2f1;
    }

    .metric-label {
      font-size: 11px;
      color: #616161;
    }

    .metric-value {
      font-size: 14px;
      font-weight: 700;
      color: #1b5e20;
    }

    .metric-note {
      font-size: 10px;
      color: #9e9e9e;
    }

    .btn-main {
      width: 100%;
      border-radius: 999px;
      padding: 10px 14px;
      border: none;
      background: #2e7d32;
      color: #fff;
      font-size: 15px;
      font-weight: 700;
      cursor: pointer;
      margin-top: 8px;
    }

    .btn-main:disabled {
      opacity: 0.6;
      cursor: default;
    }

    .btn-outline {
      width: 100%;
      border-radius: 999px;
      padding: 8px 12px;
      border: 1px solid #a5d6a7;
      background: #f8fff9;
      color: #1b5e20;
      font-size: 14px;
      font-weight: 600;
      cursor: pointer;
      margin-top: 6px;
    }

    .btn-outline.secondary {
      border-color: #90caf9;
      color: #1565c0;
      background: #e3f2fd;
    }

    .list-text {
      font-size: 13px;
      margin-top: 4px;
      color: #424242;
    }

    .list-text ul {
      margin-left: 18px;
      margin-top: 4px;
    }

    .list-text li {
      margin-bottom: 2px;
    }

    .small-note {
      font-size: 11px;
      color: #9e9e9e;
      margin-top: 6px;
    }

    .empty-message {
      font-size: 13px;
      color: #757575;
      margin-top: 4px;
    }

    footer {
      position: fixed;
      bottom: 0;
      left: 0;
      right: 0;
      display: flex;
      justify-content: center;
    }

    .bottom-nav {
      width: 100%;
      max-width: 480px;
      background: #ffffff;
      border-top: 1px solid #c8e6c9;
      display: grid;
      grid-template-columns: repeat(4, 1fr);
      padding: 4px 0;
    }

    .nav-item {
      text-align: center;
      font-size: 11px;
      color: #757575;
      padding: 4px 0;
    }

    .nav-item span.icon {
      display: block;
      font-size: 18px;
    }

    .nav-item.active {
      color: #1b5e20;
      font-weight: 700;
    }
  </style>
  <script type="module">
    import { createClient } from "https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2/+esm";

    // TODO: ‡πÅ‡∏Å‡πâ‡πÉ‡∏´‡πâ‡πÄ‡∏õ‡πá‡∏ô‡∏Ç‡∏≠‡∏á‡πÇ‡∏õ‡∏£‡πÄ‡∏à‡∏Å‡∏ï‡πå‡∏à‡∏£‡∏¥‡∏á
    const SUPABASE_URL = "https://YOUR-PROJECT-ID.supabase.co";
    const SUPABASE_ANON_KEY = "YOUR-ANON-KEY";

    const supabase = createClient(SUPABASE_URL, SUPABASE_ANON_KEY);

    let currentUser = null;
    let activeBatch = null;
    let todayStr = null;
    let todayDayNo = null;
    let todayInstar = null;
    let todayMealsTimes = null;
    let todayMealsCount = null;

    document.addEventListener("DOMContentLoaded", () => {
      initDashboard().catch(console.error);
    });

    async function initDashboard() {
      todayStr = new Date().toISOString().slice(0, 10);
      document.getElementById("todayText").textContent =
        "‡∏ß‡∏±‡∏ô‡∏ô‡∏µ‡πâ: " + formatThaiDate(new Date());

      const { data: userData, error: userError } = await supabase.auth.getUser();
      if (userError || !userData?.user) {
        // ‡∏ñ‡πâ‡∏≤‡πÑ‡∏°‡πà‡πÑ‡∏î‡πâ login ‡πÉ‡∏´‡πâ‡∏¢‡πâ‡∏≠‡∏ô‡∏Å‡∏•‡∏±‡∏ö‡πÑ‡∏õ‡∏´‡∏ô‡πâ‡∏≤ login
        window.location.href = "login.html";
        return;
      }
      currentUser = userData.user;

      await loadActiveBatch();
    }

    function formatThaiDate(d) {
      const months = [
        "‡∏°.‡∏Ñ.", "‡∏Å.‡∏û.", "‡∏°‡∏µ.‡∏Ñ.", "‡πÄ‡∏°.‡∏¢.", "‡∏û.‡∏Ñ.", "‡∏°‡∏¥.‡∏¢.",
        "‡∏Å.‡∏Ñ.", "‡∏™.‡∏Ñ.", "‡∏Å.‡∏¢.", "‡∏ï.‡∏Ñ.", "‡∏û.‡∏¢.", "‡∏ò.‡∏Ñ."
      ];
      const day = d.getDate();
      const month = months[d.getMonth()];
      const year = d.getFullYear() + 543;
      return `${day} ${month} ${year}`;
    }

    function calcDayNo(startDateStr, todayStrLocal) {
      const start = new Date(startDateStr);
      const today = new Date(todayStrLocal);
      const diffMs = today.setHours(0,0,0,0) - start.setHours(0,0,0,0);
      return Math.floor(diffMs / (1000 * 60 * 60 * 24)) + 1;
    }

    // mapping ‡πÅ‡∏ö‡∏ö‡∏á‡πà‡∏≤‡∏¢ 27 ‡∏ß‡∏±‡∏ô ‚Üí ‡πÅ‡∏ö‡πà‡∏á 5 ‡∏ß‡∏±‡∏¢
    function calcInstar(dayNo) {
      if (dayNo <= 3) return 1;
      if (dayNo <= 6) return 2;
      if (dayNo <= 9) return 3;
      if (dayNo <= 16) return 4;
      return 5;
    }

    // ‡∏ï‡∏≤‡∏£‡∏≤‡∏á‡πÄ‡∏ß‡∏•‡∏≤‡πÉ‡∏´‡πâ‡∏≠‡∏≤‡∏´‡∏≤‡∏£‡πÅ‡∏ö‡∏ö‡∏á‡πà‡∏≤‡∏¢‡∏ï‡∏≤‡∏°‡∏ß‡∏±‡∏¢‡πÑ‡∏´‡∏°
    function getMealsForInstar(instar) {
      if (instar <= 3) {
        // ‡∏ß‡∏±‡∏¢‡∏≠‡πà‡∏≠‡∏ô: 3‚Äì4 ‡∏°‡∏∑‡πâ‡∏≠
        return {
          times: "07:00, 11:00, 16:00, 20:00",
          count: 4,
          description: "‡∏ß‡∏±‡∏¢‡∏≠‡πà‡∏≠‡∏ô‡∏Ñ‡∏ß‡∏£‡πÉ‡∏´‡πâ‡∏ñ‡∏µ‡πà 3‚Äì4 ‡∏°‡∏∑‡πâ‡∏≠/‡∏ß‡∏±‡∏ô ‡πÄ‡∏û‡∏∑‡πà‡∏≠‡πÉ‡∏´‡πâ‡πÉ‡∏ö‡∏´‡∏°‡πà‡∏≠‡∏ô‡∏ä‡∏∏‡πà‡∏°‡∏ä‡∏∑‡πâ‡∏ô ‡πÑ‡∏°‡πà‡πÅ‡∏´‡πâ‡∏á‡∏Å‡∏£‡∏≠‡∏ö"
        };
      } else {
        // ‡∏ß‡∏±‡∏¢ 4‚Äì5: 3 ‡∏°‡∏∑‡πâ‡∏≠ (‡πÄ‡∏ä‡πâ‡∏≤‚Äì‡∏ö‡πà‡∏≤‡∏¢‚Äì‡∏Ñ‡πà‡∏≥)
        return {
          times: "07:00, 13:00, 18:00",
          count: 3,
          description: "‡∏ß‡∏±‡∏¢ 4‚Äì5 ‡∏™‡∏≤‡∏°‡∏≤‡∏£‡∏ñ‡∏•‡∏î‡πÄ‡∏´‡∏•‡∏∑‡∏≠ 2‚Äì3 ‡∏°‡∏∑‡πâ‡∏≠/‡∏ß‡∏±‡∏ô ‡πÅ‡∏ï‡πà‡πÉ‡∏´‡πâ‡∏õ‡∏£‡∏¥‡∏°‡∏≤‡∏ì‡∏ï‡πà‡∏≠‡∏°‡∏∑‡πâ‡∏≠‡πÄ‡∏û‡∏¥‡πà‡∏°‡∏Ç‡∏∂‡πâ‡∏ô"
        };
      }
    }

    async function loadActiveBatch() {
      const statusEl = document.getElementById("batchStatus");
      const metricsEl = document.getElementById("batchMetrics");
      const feedingStatusEl = document.getElementById("feedingStatus");
      const btnLogFeeding = document.getElementById("btnLogFeeding");
      const btnGoFeedingPlan = document.getElementById("btnGoFeedingPlan");
      const btnGoLeafRecom = document.getElementById("btnGoLeafRecom");

      statusEl.textContent = "‡∏Å‡∏≥‡∏•‡∏±‡∏á‡πÇ‡∏´‡∏•‡∏î‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏£‡∏∏‡πà‡∏ô‡∏Å‡∏≤‡∏£‡πÄ‡∏•‡∏µ‡πâ‡∏¢‡∏á...";
      feedingStatusEl.textContent = "";
      btnLogFeeding.disabled = true;

      const { data, error } = await supabase
        .from("silkworm_batches")
        .select("*")
        .eq("user_id", currentUser.id)
        .eq("status", "raising")
        .limit(1)
        .maybeSingle();

      if (error) {
        console.error(error);
        statusEl.textContent = "‡πÇ‡∏´‡∏•‡∏î‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡πÑ‡∏°‡πà‡∏™‡∏≥‡πÄ‡∏£‡πá‡∏à ‡πÇ‡∏õ‡∏£‡∏î‡∏•‡∏≠‡∏á‡πÉ‡∏´‡∏°‡πà‡∏≠‡∏µ‡∏Å‡∏Ñ‡∏£‡∏±‡πâ‡∏á";
        return;
      }

      if (!data) {
        activeBatch = null;
        statusEl.innerHTML =
          "‡∏ï‡∏≠‡∏ô‡∏ô‡∏µ‡πâ‡∏Ñ‡∏∏‡∏ì‡∏¢‡∏±‡∏á‡πÑ‡∏°‡πà‡πÑ‡∏î‡πâ‡πÄ‡∏£‡∏¥‡πà‡∏°‡∏£‡∏∏‡πà‡∏ô‡∏Å‡∏≤‡∏£‡πÄ‡∏•‡∏µ‡πâ‡∏¢‡∏á‡πÑ‡∏´‡∏°‡∏£‡∏≠‡∏ö‡πÉ‡∏´‡∏°‡πà<br>" +
          "‡∏Å‡∏£‡∏∏‡∏ì‡∏≤‡πÄ‡∏£‡∏¥‡πà‡∏°‡∏£‡∏≠‡∏ö‡πÉ‡∏´‡∏°‡πà‡∏´‡∏•‡∏±‡∏á‡∏à‡∏≤‡∏Å‡∏û‡∏±‡∏Å‡πÇ‡∏£‡∏á‡πÄ‡∏•‡∏µ‡πâ‡∏¢‡∏á‡πÅ‡∏•‡∏∞‡∏ó‡∏≥‡∏Ñ‡∏ß‡∏≤‡∏°‡∏™‡∏∞‡∏≠‡∏≤‡∏î‡πÄ‡∏£‡∏µ‡∏¢‡∏ö‡∏£‡πâ‡∏≠‡∏¢‡πÅ‡∏•‡πâ‡∏ß";
        metricsEl.innerHTML = "";
        feedingStatusEl.innerHTML =
          "‡∏¢‡∏±‡∏á‡πÑ‡∏°‡πà‡∏°‡∏µ‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡πÉ‡∏´‡πâ‡∏≠‡∏≤‡∏´‡∏≤‡∏£ ‡πÄ‡∏ô‡∏∑‡πà‡∏≠‡∏á‡∏à‡∏≤‡∏Å‡∏¢‡∏±‡∏á‡πÑ‡∏°‡πà‡∏°‡∏µ‡∏£‡∏∏‡πà‡∏ô‡∏ó‡∏µ‡πà‡∏Å‡∏≥‡∏•‡∏±‡∏á‡πÄ‡∏•‡∏µ‡πâ‡∏¢‡∏á";
        btnLogFeeding.disabled = true;
        btnGoFeedingPlan.onclick = () => {
          window.location.href = "feeding_plan.html";
        };
        btnGoLeafRecom.onclick = () => {
          window.location.href = "mulberry_recommendation.html";
        };
        return;
      }

      activeBatch = data;

      const dayNo = calcDayNo(activeBatch.start_date, todayStr);
      todayDayNo = dayNo < 1 ? 1 : dayNo;
      todayInstar = calcInstar(todayDayNo);

      const { times, count, description } = getMealsForInstar(todayInstar);
      todayMealsTimes = times;
      todayMealsCount = count;

      statusEl.textContent =
        `‡∏£‡∏∏‡πà‡∏ô‡πÄ‡∏•‡∏µ‡πâ‡∏¢‡∏á‡∏õ‡∏±‡∏à‡∏à‡∏∏‡∏ö‡∏±‡∏ô: ‡πÄ‡∏£‡∏¥‡πà‡∏°‡πÄ‡∏•‡∏µ‡πâ‡∏¢‡∏á‡∏ß‡∏±‡∏ô‡∏ó‡∏µ‡πà ${formatThaiDate(new Date(activeBatch.start_date))}`;

      metricsEl.innerHTML = `
        <div class="metrics-grid">
          <div class="metric-box">
            <div class="metric-label">‡∏ß‡∏±‡∏ô‡πÄ‡∏•‡∏µ‡πâ‡∏¢‡∏á‡∏ß‡∏±‡∏ô‡∏ô‡∏µ‡πâ</div>
            <div class="metric-value">‡∏ß‡∏±‡∏ô‡∏ó‡∏µ‡πà ${todayDayNo}</div>
            <div class="metric-note">‡πÄ‡∏•‡∏µ‡πâ‡∏¢‡∏á‡∏™‡∏∞‡∏™‡∏°‡∏ï‡∏±‡πâ‡∏á‡πÅ‡∏ï‡πà‡∏ß‡∏±‡∏ô‡πÄ‡∏£‡∏¥‡πà‡∏°‡∏ï‡πâ‡∏ô</div>
          </div>
          <div class="metric-box">
            <div class="metric-label">‡∏ß‡∏±‡∏¢‡∏´‡∏ô‡∏≠‡∏ô‡πÑ‡∏´‡∏°‡∏ß‡∏±‡∏ô‡∏ô‡∏µ‡πâ</div>
            <div class="metric-value">‡∏ß‡∏±‡∏¢‡∏ó‡∏µ‡πà ${todayInstar}</div>
            <div class="metric-note">‡∏ß‡∏±‡∏¢ 1‚Äì3 = ‡∏ß‡∏±‡∏¢‡∏≠‡πà‡∏≠‡∏ô, ‡∏ß‡∏±‡∏¢ 4‚Äì5 = ‡∏ß‡∏±‡∏¢‡πÅ‡∏Å‡πà</div>
          </div>
          <div class="metric-box">
            <div class="metric-label">‡∏à‡∏≥‡∏ô‡∏ß‡∏ô‡πÅ‡∏ú‡πà‡∏ô‡πÑ‡∏Ç‡πà‡∏ó‡∏µ‡πà‡πÄ‡∏•‡∏µ‡πâ‡∏¢‡∏á</div>
            <div class="metric-value">${activeBatch.egg_sheet_count ?? "-" } ‡πÅ‡∏ú‡πà‡∏ô</div>
            <div class="metric-note">‡∏Å‡∏•‡∏∏‡πà‡∏°‡∏û‡∏±‡∏ô‡∏ò‡∏∏‡πå: ${activeBatch.breed_group || "-"}</div>
          </div>
          <div class="metric-box">
            <div class="metric-label">‡∏™‡∏ñ‡∏≤‡∏ô‡∏∞‡∏£‡∏∏‡πà‡∏ô‡πÄ‡∏•‡∏µ‡πâ‡∏¢‡∏á</div>
            <div class="metric-value">‡∏Å‡∏≥‡∏•‡∏±‡∏á‡πÄ‡∏•‡∏µ‡πâ‡∏¢‡∏á‡∏≠‡∏¢‡∏π‡πà</div>
            <div class="metric-note">‡∏£‡∏∞‡∏ö‡∏ö‡∏à‡∏≥‡∏Å‡∏±‡∏î 1 ‡∏£‡∏∏‡πà‡∏ô‡∏ï‡πà‡∏≠‡∏ú‡∏π‡πâ‡πÉ‡∏ä‡πâ 1 ‡∏Ñ‡∏ô</div>
          </div>
        </div>
      `;

      // ‡πÅ‡∏™‡∏î‡∏á‡πÅ‡∏ú‡∏ô‡πÉ‡∏´‡πâ‡∏≠‡∏≤‡∏´‡∏≤‡∏£‡∏ß‡∏±‡∏ô‡∏ô‡∏µ‡πâ
      feedingStatusEl.innerHTML = `
        <div class="badge badge-green">‡∏ß‡∏±‡∏ô‡πÄ‡∏•‡∏µ‡πâ‡∏¢‡∏á‡∏ó‡∏µ‡πà ${todayDayNo}</div>
        <div class="badge badge-orange">‡∏ß‡∏±‡∏¢‡∏ó‡∏µ‡πà ${todayInstar}</div>
        <div class="badge badge-blue">${count} ‡∏°‡∏∑‡πâ‡∏≠/‡∏ß‡∏±‡∏ô</div>
        <div class="list-text">
          <strong>‡∏£‡∏≠‡∏ö‡πÉ‡∏´‡πâ‡∏≠‡∏≤‡∏´‡∏≤‡∏£‡∏ó‡∏µ‡πà‡πÅ‡∏ô‡∏∞‡∏ô‡∏≥:</strong><br>
          ${times} ‡∏ô.<br>
          <ul>
            <li>${description}</li>
            <li>‡∏õ‡∏£‡∏±‡∏ö‡∏ï‡∏≤‡∏°‡∏™‡∏†‡∏≤‡∏û‡πÉ‡∏ö‡∏´‡∏°‡πà‡∏≠‡∏ô‡∏à‡∏£‡∏¥‡∏á ‡∏ñ‡πâ‡∏≤‡πÉ‡∏ö‡πÅ‡∏´‡πâ‡∏á‡πÄ‡∏£‡πá‡∏ß‡πÉ‡∏´‡πâ‡πÄ‡∏û‡∏¥‡πà‡∏°‡∏Ñ‡∏ß‡∏≤‡∏°‡∏ñ‡∏µ‡πà</li>
          </ul>
        </div>
      `;

      // ‡∏Å‡∏≥‡∏´‡∏ô‡∏î‡∏õ‡∏∏‡πà‡∏°‡∏•‡∏¥‡∏á‡∏Å‡πå‡πÑ‡∏õ‡∏´‡∏ô‡πâ‡∏≤‡∏≠‡∏∑‡πà‡∏ô
      btnGoFeedingPlan.onclick = () => {
        window.location.href = "feeding_plan.html";
      };
      btnGoLeafRecom.onclick = () => {
        window.location.href = "mulberry_recommendation.html";
      };

      // ‡πÇ‡∏´‡∏•‡∏î log ‡∏ß‡∏±‡∏ô‡∏ô‡∏µ‡πâ
      await loadTodayFeedingLog();
    }

    async function loadTodayFeedingLog() {
      const summaryEl = document.getElementById("feedingLogSummary");
      const btnLogFeeding = document.getElementById("btnLogFeeding");

      if (!activeBatch) {
        summaryEl.textContent = "‡∏¢‡∏±‡∏á‡πÑ‡∏°‡πà‡∏°‡∏µ‡∏£‡∏∏‡πà‡∏ô‡∏Å‡∏≤‡∏£‡πÄ‡∏•‡∏µ‡πâ‡∏¢‡∏á‡∏ó‡∏µ‡πà‡∏Å‡∏≥‡∏•‡∏±‡∏á active";
        btnLogFeeding.disabled = true;
        return;
      }

      const { data, error } = await supabase
        .from("feeding_logs")
        .select("*")
        .eq("batch_id", activeBatch.id)
        .eq("feeding_date", todayStr)
        .limit(1);

      if (error) {
        console.error(error);
        summaryEl.textContent = "‡πÇ‡∏´‡∏•‡∏î‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏Å‡∏≤‡∏£‡πÉ‡∏´‡πâ‡∏≠‡∏≤‡∏´‡∏≤‡∏£‡πÑ‡∏°‡πà‡∏™‡∏≥‡πÄ‡∏£‡πá‡∏à";
        btnLogFeeding.disabled = true;
        return;
      }

      if (!data || data.length === 0) {
        summaryEl.innerHTML = `
          <div class="empty-message">
            ‡∏ß‡∏±‡∏ô‡∏ô‡∏µ‡πâ‡∏¢‡∏±‡∏á‡πÑ‡∏°‡πà‡πÑ‡∏î‡πâ‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å‡∏ß‡πà‡∏≤‡πÉ‡∏´‡πâ‡∏≠‡∏≤‡∏´‡∏≤‡∏£‡πÅ‡∏•‡πâ‡∏ß<br>
            ‡πÄ‡∏°‡∏∑‡πà‡∏≠‡πÉ‡∏´‡πâ‡∏≠‡∏≤‡∏´‡∏≤‡∏£‡∏Ñ‡∏£‡∏ö‡∏ï‡∏≤‡∏°‡πÅ‡∏ú‡∏ô ‡∏™‡∏≤‡∏°‡∏≤‡∏£‡∏ñ‡∏Å‡∏î‡∏õ‡∏∏‡πà‡∏°‡∏î‡πâ‡∏≤‡∏ô‡∏•‡πà‡∏≤‡∏á‡πÄ‡∏û‡∏∑‡πà‡∏≠‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å‡∏Ñ‡πà‡∏∞
          </div>
        `;
        btnLogFeeding.disabled = false;
        btnLogFeeding.onclick = logTodayFeeding;
      } else {
        const log = data[0];
        summaryEl.innerHTML = `
          <div class="list-text">
            <strong>‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å‡∏ß‡∏±‡∏ô‡∏ô‡∏µ‡πâ‡πÅ‡∏•‡πâ‡∏ß</strong><br>
            ‡∏ß‡∏±‡∏ô‡∏ó‡∏µ‡πà: ${formatThaiDate(new Date(log.feeding_date))}<br>
            ‡∏ß‡∏±‡∏ô‡πÄ‡∏•‡∏µ‡πâ‡∏¢‡∏á‡∏ó‡∏µ‡πà: ${log.day_no}, ‡∏ß‡∏±‡∏¢‡∏ó‡∏µ‡πà: ${log.instar}<br>
            ‡πÉ‡∏´‡πâ‡∏≠‡∏≤‡∏´‡∏≤‡∏£ ${log.meals_count} ‡∏°‡∏∑‡πâ‡∏≠ ‡πÄ‡∏ß‡∏•‡∏≤: ${log.meals_times || "-"}<br>
            <span class="metric-note">‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å‡πÄ‡∏°‡∏∑‡πà‡∏≠: ${new Date(log.created_at).toLocaleString("th-TH")}</span>
          </div>
        `;
        btnLogFeeding.disabled = true;
        btnLogFeeding.onclick = null;
      }
    }

    async function logTodayFeeding() {
      if (!activeBatch || !currentUser) return;

      const btn = document.getElementById("btnLogFeeding");
      btn.disabled = true;
      btn.textContent = "‡∏Å‡∏≥‡∏•‡∏±‡∏á‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å...";

      const { error } = await supabase.from("feeding_logs").insert({
        batch_id: activeBatch.id,
        user_id: currentUser.id,
        feeding_date: todayStr,
        day_no: todayDayNo,
        instar: todayInstar,
        meals_times: todayMealsTimes,
        meals_count: todayMealsCount
      });

      if (error) {
        console.error(error);
        alert("‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å‡πÑ‡∏°‡πà‡∏™‡∏≥‡πÄ‡∏£‡πá‡∏à: " + error.message);
        btn.disabled = false;
        btn.textContent = "‚úî ‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å‡∏ß‡πà‡∏≤‡πÉ‡∏´‡πâ‡∏≠‡∏≤‡∏´‡∏≤‡∏£‡∏Ñ‡∏£‡∏ö‡πÅ‡∏•‡πâ‡∏ß‡∏ß‡∏±‡∏ô‡∏ô‡∏µ‡πâ";
        return;
      }

      btn.textContent = "‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å‡πÄ‡∏£‡∏µ‡∏¢‡∏ö‡∏£‡πâ‡∏≠‡∏¢‡πÅ‡∏•‡πâ‡∏ß ‚úî";
      await loadTodayFeedingLog();
    }

    // ‡∏™‡∏≥‡∏´‡∏£‡∏±‡∏ö‡∏õ‡∏∏‡πà‡∏°‡∏≠‡∏≠‡∏Å‡∏à‡∏≤‡∏Å‡∏£‡∏∞‡∏ö‡∏ö‡πÉ‡∏ô bottom nav
    async function logout() {
      await supabase.auth.signOut();
      window.location.href = "login.html";
    }

    window.logout = logout; // ‡πÉ‡∏´‡πâ‡πÄ‡∏£‡∏µ‡∏¢‡∏Å‡∏à‡∏≤‡∏Å onclick ‡πÑ‡∏î‡πâ
  </script>
</head>
<body>
  <div class="app-shell">
    <header>
      <div class="title-block">
        <h1><span class="icon">üßµ</span>‡∏≠‡∏≤‡∏£‡∏±‡∏Å‡∏Ç‡∏≤‡∏£‡∏±‡∏á‡πÑ‡∏´‡∏°‡πÄ‡∏•‡∏µ‡πâ‡∏¢‡∏á‡∏≠‡∏±‡∏à‡∏â‡∏£‡∏¥‡∏¢‡∏∞</h1>
        <div class="subtitle">Dashboard ‡∏Å‡∏≤‡∏£‡πÉ‡∏´‡πâ‡∏≠‡∏≤‡∏´‡∏≤‡∏£‡∏´‡∏ô‡∏≠‡∏ô‡πÑ‡∏´‡∏° 5 ‡∏ß‡∏±‡∏¢</div>
      </div>
      <div class="today-text" id="todayText">‡∏ß‡∏±‡∏ô‡∏ô‡∏µ‡πâ: -</div>
    </header>

    <main>
      <!-- ‡∏Å‡∏≤‡∏£‡πå‡∏î‡∏™‡∏ñ‡∏≤‡∏ô‡∏∞‡∏£‡∏∏‡πà‡∏ô‡πÄ‡∏•‡∏µ‡πâ‡∏¢‡∏á -->
      <section class="card">
        <div class="card-header">
          <div class="card-header-icon">üì¶</div>
          <div class="card-header-title">‡∏™‡∏ñ‡∏≤‡∏ô‡∏∞‡∏£‡∏∏‡πà‡∏ô‡∏Å‡∏≤‡∏£‡πÄ‡∏•‡∏µ‡πâ‡∏¢‡∏á‡∏õ‡∏±‡∏à‡∏à‡∏∏‡∏ö‡∏±‡∏ô</div>
        </div>
        <div id="batchStatus" class="card-subtitle">
          ‡∏Å‡∏≥‡∏•‡∏±‡∏á‡πÇ‡∏´‡∏•‡∏î‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏£‡∏∏‡πà‡∏ô‡∏Å‡∏≤‡∏£‡πÄ‡∏•‡∏µ‡πâ‡∏¢‡∏á...
        </div>
        <div id="batchMetrics"></div>
        <div class="small-note">
          * ‡∏£‡∏∞‡∏ö‡∏ö‡∏à‡∏≥‡∏Å‡∏±‡∏î‡πÉ‡∏´‡πâ‡πÄ‡∏Å‡∏©‡∏ï‡∏£‡∏Å‡∏£‡πÄ‡∏•‡∏µ‡πâ‡∏¢‡∏á‡∏ó‡∏µ‡∏•‡∏∞ 1 ‡∏£‡∏∏‡πà‡∏ô‡∏ï‡πà‡∏≠‡πÇ‡∏£‡∏á‡πÄ‡∏•‡∏µ‡πâ‡∏¢‡∏á ‡πÄ‡∏û‡∏∑‡πà‡∏≠‡∏õ‡πâ‡∏≠‡∏á‡∏Å‡∏±‡∏ô‡πÇ‡∏£‡∏Ñ‡πÅ‡∏•‡∏∞‡πÉ‡∏´‡πâ‡∏°‡∏µ‡∏ä‡πà‡∏ß‡∏á‡∏û‡∏±‡∏Å‡∏ó‡∏≥‡∏Ñ‡∏ß‡∏≤‡∏°‡∏™‡∏∞‡∏≠‡∏≤‡∏î
        </div>
      </section>

      <!-- ‡∏Å‡∏≤‡∏£‡πå‡∏î‡πÅ‡∏ú‡∏ô‡πÉ‡∏´‡πâ‡∏≠‡∏≤‡∏´‡∏≤‡∏£‡∏ß‡∏±‡∏ô‡∏ô‡∏µ‡πâ -->
      <section class="card">
        <div class="card-header">
          <div class="card-header-icon">üçÉ</div>
          <div class="card-header-title">‡πÅ‡∏ú‡∏ô‡πÉ‡∏´‡πâ‡∏≠‡∏≤‡∏´‡∏≤‡∏£‡∏´‡∏ô‡∏≠‡∏ô‡πÑ‡∏´‡∏°‡∏™‡∏≥‡∏´‡∏£‡∏±‡∏ö‡∏ß‡∏±‡∏ô‡∏ô‡∏µ‡πâ</div>
        </div>
        <div id="feedingStatus" class="card-subtitle">
          ‡∏Å‡∏≥‡∏•‡∏±‡∏á‡∏Ñ‡∏≥‡∏ô‡∏ß‡∏ì‡πÅ‡∏ú‡∏ô‡πÉ‡∏´‡πâ‡∏≠‡∏≤‡∏´‡∏≤‡∏£‡∏ï‡∏≤‡∏°‡∏ß‡∏±‡∏ô‡πÄ‡∏•‡∏µ‡πâ‡∏¢‡∏á‡πÅ‡∏•‡∏∞‡∏ß‡∏±‡∏¢‡πÑ‡∏´‡∏°...
        </div>

        <button class="btn-outline" id="btnGoFeedingPlan">
          üìã ‡∏î‡∏π‡πÅ‡∏ú‡∏ô‡πÉ‡∏´‡πâ‡∏≠‡∏≤‡∏´‡∏≤‡∏£ 27 ‡∏ß‡∏±‡∏ô (‡∏•‡∏∞‡πÄ‡∏≠‡∏µ‡∏¢‡∏î)
        </button>
        <button class="btn-outline secondary" id="btnGoLeafRecom">
          üåø ‡∏Ñ‡∏≥‡∏ô‡∏ß‡∏ì‡∏õ‡∏£‡∏¥‡∏°‡∏≤‡∏ì‡πÉ‡∏ö‡∏´‡∏°‡πà‡∏≠‡∏ô‡∏ó‡∏µ‡πà‡∏ï‡πâ‡∏≠‡∏á‡πÄ‡∏ï‡∏£‡∏µ‡∏¢‡∏°
        </button>

        <div class="small-note">
          * ‡∏õ‡∏£‡∏¥‡∏°‡∏≤‡∏ì‡πÉ‡∏ö‡∏´‡∏°‡πà‡∏≠‡∏ô‡∏Ñ‡∏ß‡∏£‡∏õ‡∏£‡∏±‡∏ö‡∏ï‡∏≤‡∏°‡∏à‡∏≥‡∏ô‡∏ß‡∏ô‡πÅ‡∏ú‡πà‡∏ô‡πÑ‡∏Ç‡πà‡πÅ‡∏•‡∏∞‡∏õ‡∏£‡∏∞‡∏™‡∏ö‡∏Å‡∏≤‡∏£‡∏ì‡πå‡∏à‡∏£‡∏¥‡∏á‡∏Ç‡∏≠‡∏á‡πÄ‡∏Å‡∏©‡∏ï‡∏£‡∏Å‡∏£
        </div>
      </section>

      <!-- ‡∏Å‡∏≤‡∏£‡πå‡∏î‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å‡∏Å‡∏≤‡∏£‡πÉ‡∏´‡πâ‡∏≠‡∏≤‡∏´‡∏≤‡∏£ -->
      <section class="card">
        <div class="card-header">
          <div class="card-header-icon">‚úÖ</div>
          <div class="card-header-title">‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å‡∏Å‡∏≤‡∏£‡πÉ‡∏´‡πâ‡∏≠‡∏≤‡∏´‡∏≤‡∏£‡∏ß‡∏±‡∏ô‡∏ô‡∏µ‡πâ</div>
        </div>
        <div id="feedingLogSummary" class="card-subtitle">
          ‡∏Å‡∏≥‡∏•‡∏±‡∏á‡∏ï‡∏£‡∏ß‡∏à‡∏™‡∏≠‡∏ö‡∏ß‡πà‡∏≤‡∏°‡∏µ‡∏Å‡∏≤‡∏£‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å‡∏ß‡∏±‡∏ô‡∏ô‡∏µ‡πâ‡πÅ‡∏•‡πâ‡∏ß‡∏´‡∏£‡∏∑‡∏≠‡∏¢‡∏±‡∏á...
        </div>

        <button class="btn-main" id="btnLogFeeding" disabled>
          ‚úî ‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å‡∏ß‡πà‡∏≤‡πÉ‡∏´‡πâ‡∏≠‡∏≤‡∏´‡∏≤‡∏£‡∏Ñ‡∏£‡∏ö‡πÅ‡∏•‡πâ‡∏ß‡∏ß‡∏±‡∏ô‡∏ô‡∏µ‡πâ
        </button>

        <div class="small-note">
          * ‡∏õ‡∏∏‡πà‡∏°‡∏ô‡∏µ‡πâ‡πÉ‡∏ä‡πâ‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å‡πÅ‡∏ö‡∏ö‡∏™‡∏£‡∏∏‡∏õ‡∏ß‡πà‡∏≤ ‚Äú‡πÉ‡∏´‡πâ‡∏≠‡∏≤‡∏´‡∏≤‡∏£‡∏Ñ‡∏£‡∏ö‡∏ï‡∏≤‡∏°‡πÅ‡∏ú‡∏ô‡πÅ‡∏•‡πâ‡∏ß‚Äù<br>
          ‡πÉ‡∏ô‡∏≠‡∏ô‡∏≤‡∏Ñ‡∏ï‡∏™‡∏≤‡∏°‡∏≤‡∏£‡∏ñ‡πÄ‡∏û‡∏¥‡πà‡∏°‡∏Å‡∏≤‡∏£‡∏Å‡∏£‡∏≠‡∏Å‡∏õ‡∏£‡∏¥‡∏°‡∏≤‡∏ì‡πÉ‡∏ö‡∏´‡∏°‡πà‡∏≠‡∏ô‡πÅ‡∏•‡∏∞‡∏≠‡∏∏‡∏ì‡∏´‡∏†‡∏π‡∏°‡∏¥/‡∏Ñ‡∏ß‡∏≤‡∏°‡∏ä‡∏∑‡πâ‡∏ô‡πÑ‡∏î‡πâ
        </div>
      </section>
    </main>

    <!-- Bottom navigation -->
    <footer>
      <nav class="bottom-nav">
        <div class="nav-item active">
          <span class="icon">üè†</span>
          ‡∏´‡∏ô‡πâ‡∏≤‡∏´‡∏•‡∏±‡∏Å
        </div>
        <div class="nav-item" onclick="window.location.href='stats.html'">
          <span class="icon">üìä</span>
          ‡∏™‡∏ñ‡∏¥‡∏ï‡∏¥
        </div>
        <div class="nav-item" onclick="window.location.href='settings.html'">
          <span class="icon">‚öôÔ∏è</span>
          ‡∏ï‡∏±‡πâ‡∏á‡∏Ñ‡πà‡∏≤
        </div>
        <div class="nav-item" onclick="logout()">
          <span class="icon">üö™</span>
          ‡∏≠‡∏≠‡∏Å‡∏à‡∏≤‡∏Å‡∏£‡∏∞‡∏ö‡∏ö
        </div>
      </nav>
    </footer>
  </div>
</body>
</html>


