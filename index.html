<!DOCTYPE html>
<html lang="th">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>อารักขารังไหมเลี้ยงอัจฉริยะ – Prototype</title>

  <!-- ฟอนต์ -->
  <link rel="preconnect" href="https://fonts.googleapis.com">
  <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
  <link href="https://fonts.googleapis.com/css2?family=Sarabun:wght@300;400;600;700&display=swap" rel="stylesheet">

  <!-- Chart.js -->
  <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>

  <!-- Supabase JS -->
  <script src="https://unpkg.com/@supabase/supabase-js@2"></script>

  <style>
    * { margin:0; padding:0; box-sizing:border-box; }

    body {
      font-family:'Sarabun', Arial, sans-serif;
      background:linear-gradient(135deg,#e8f5e8 0%,#f1f8e9 100%);
      min-height:100vh;
      font-size:22px;
      line-height:1.6;
      color:#234530;
    }

    .app-shell {
      max-width:1200px;
      margin:24px auto 40px;
      padding:16px;
    }

    /* Header */
    .app-header {
      display:flex;
      align-items:center;
      justify-content:space-between;
      margin-bottom:12px;
    }

    .brand {
      display:flex;
      align-items:center;
      gap:12px;
    }

    .brand-logo {
      width:52px;height:52px;
      border-radius:16px;
      background:#66bb6a;
      display:flex;
      align-items:center;
      justify-content:center;
      color:#fff;
      font-weight:700;
      font-size:26px;
      box-shadow:0 6px 14px rgba(76,175,80,0.25);
    }

    .brand-text-title {
      font-size:26px;
      font-weight:700;
      color:#1b5e20;
    }

    .brand-text-subtitle {
      font-size:16px;
      color:#558b2f;
    }

    .header-pill {
      padding:8px 18px;
      border-radius:999px;
      background:#c8e6c9;
      font-size:16px;
      color:#2e7d32;
      border:1px solid #a5d6a7;
      box-shadow:0 3px 6px rgba(56,142,60,0.2);
    }

    /* การ์ดหลัก */
    .card {
      background:#ffffff;
      border-radius:20px;
      box-shadow:0 12px 30px rgba(46,125,50,0.18);
      padding:20px 24px;
      margin-top:16px;
    }

    .card-header-row {
      display:flex;
      align-items:center;
      justify-content:space-between;
      margin-bottom:8px;
      gap:8px;
    }

    .card-title {
      font-size:22px;
      font-weight:700;
      color:#1b5e20;
    }

    .card-subtitle {
      font-size:16px;
      color:#78909c;
    }

    /* layout login/register */
    .grid-2 {
      display:grid;
      grid-template-columns:1.1fr 1.2fr;
      gap:24px;
    }
    @media (max-width:900px){
      .grid-2 { grid-template-columns:1fr; }
    }

    .section-title {
      font-size:20px;
      font-weight:700;
      color:#1b5e20;
      margin-bottom:6px;
    }

    .section-hint {
      font-size:15px;
      color:#607d8b;
      margin-bottom:14px;
    }

    .form-group { margin-bottom:12px; }

    label {
      display:block;
      font-size:16px;
      margin-bottom:4px;
      color:#33691e;
    }

    input[type="text"],
    input[type="email"],
    input[type="password"],
    input[type="number"],
    input[type="date"] {
      width:100%;
      padding:10px 12px;
      border-radius:12px;
      border:1px solid #c5e1a5;
      background:#f9fff7;
      font-size:18px;
      outline:none;
      transition:border .15s, box-shadow .15s, background .15s;
    }
    input:focus {
      border-color:#66bb6a;
      box-shadow:0 0 0 3px rgba(102,187,106,0.3);
      background:#ffffff;
    }

    .btn {
      display:inline-flex;
      align-items:center;
      justify-content:center;
      padding:10px 22px;
      border-radius:999px;
      font-size:18px;
      font-weight:600;
      border:none;
      cursor:pointer;
      transition:transform .08s, box-shadow .1s, background .1s;
    }
    .btn-primary {
      background:#43a047;
      color:#fff;
      box-shadow:0 8px 18px rgba(56,142,60,0.5);
    }
    .btn-primary:hover {
      transform:translateY(-1px);
      box-shadow:0 10px 22px rgba(56,142,60,0.6);
      background:#388e3c;
    }
    .btn-outline {
      background:#ffffff;
      color:#2e7d32;
      border:1px solid #81c784;
      box-shadow:0 4px 10px rgba(76,175,80,0.25);
    }
    .btn-outline:hover {
      background:#e8f5e9;
      transform:translateY(-1px);
    }
    .btn-danger {
      background:#e53935;
      color:#fff;
      box-shadow:0 8px 18px rgba(211,47,47,0.45);
    }
    .btn-danger:hover { background:#c62828; }
    .btn-sm { font-size:15px;padding:6px 14px; }

    .text-right { text-align:right; }

    .badge-user {
      padding:6px 14px;
      border-radius:999px;
      background:#e8f5e9;
      border:1px solid #c5e1a5;
      font-size:15px;
      color:#2e7d32;
      display:inline-flex;
      align-items:center;
      gap:6px;
    }

    .status-bar {
      margin-top:14px;
      border-radius:12px;
      padding:10px 14px;
      font-size:16px;
      display:flex;
      align-items:center;
      gap:8px;
    }
    .status-info   { background:#fff8e1;color:#8d6e63;border:1px solid #ffe082; }
    .status-success{ background:#e8f5e9;color:#2e7d32;border:1px solid #c5e1a5;}
    .status-error  { background:#ffebee;color:#c62828;border:1px solid #ffcdd2;}

    /* DASHBOARD */
    #dashboard-section { margin-top:16px; }

    .dashboard-grid {
      display:grid;
      grid-template-columns:2.2fr 1.8fr;
      gap:20px;
      margin-top:8px;
    }
    @media (max-width:1024px){
      .dashboard-grid { grid-template-columns:1fr; }
    }

    .stat-grid {
      display:grid;
      grid-template-columns:repeat(auto-fit,minmax(210px,1fr));
      gap:14px;
      margin-bottom:16px;
    }
    .stat-card {
      background:#f9fff7;
      border-radius:16px;
      padding:10px 14px;
      border:1px solid #c5e1a5;
    }
    .stat-label {
      font-size:16px;
      color:#607d8b;
      margin-bottom:4px;
    }
    .stat-value {
      font-size:24px;
      font-weight:700;
      color:#1b5e20;
    }
    .stat-unit {
      font-size:15px;
      color:#78909c;
    }

    .table-wrapper {
      margin-top:6px;
      border-radius:16px;
      border:1px solid #c5e1a5;
      overflow:hidden;
    }
    table {
      width:100%;
      border-collapse:collapse;
      font-size:18px;
    }
    thead { background:#e8f5e9; }
    th, td {
      padding:8px 10px;
      border-bottom:1px solid #e0e0e0;
    }
    th {
      text-align:left;
      font-weight:600;
      color:#33691e;
    }
    tbody tr:nth-child(even){ background:#fafafa; }

    .empty-row {
      text-align:center;
      color:#90a4ae;
      font-size:16px;
      padding:14px 10px;
    }

    .chart-box {
      border-radius:16px;
      border:1px solid #c5e1a5;
      padding:12px;
      background:#f9fff7;
      height:100%;
      display:flex;
      flex-direction:column;
    }
    .chart-header {
      display:flex;
      align-items:center;
      justify-content:space-between;
      margin-bottom:6px;
    }
    .chart-title { font-size:18px;font-weight:700;color:#1b5e20; }
    .chart-subtitle { font-size:14px;color:#78909c; }

    canvas { flex:1; }

    .hidden { display:none !important; }
  </style>
</head>
<body>
<div class="app-shell">
  <!-- Header -->
  <header class="app-header">
    <div class="brand">
      <div class="brand-logo">ไหม</div>
      <div>
        <div class="brand-text-title">อารักขารังไหมเลี้ยงอัจฉริยะ</div>
        <div class="brand-text-subtitle">
          ระบบติดตามผลผลิตไหมเลี้ยงสำหรับเกษตรกร – Prototype
        </div>
      </div>
    </div>
    <div class="header-pill">Supabase + Chart.js · เวอร์ชัน MVP</div>
  </header>

  <!-- 1) AUTH SECTION -->
  <section id="auth-section" class="card">
    <div class="card-header-row">
      <div>
        <div class="card-title">ลงทะเบียนและสร้างโปรไฟล์สำเร็จแล้ว กรุณาเข้าสู่ระบบ</div>
        <div class="card-subtitle">สำหรับเกษตรกร: ใช้อีเมลและรหัสผ่านในการเข้าใช้งานครั้งถัดไป</div>
      </div>
    </div>

    <div class="grid-2">
      <!-- Login -->
      <div>
        <div class="section-title">เข้าสู่ระบบ</div>
        <div class="section-hint">
          สำหรับเกษตรกรที่มีบัญชีอยู่แล้ว กรุณากรอกอีเมลและรหัสผ่าน
        </div>

        <div class="form-group">
          <label for="login-email">อีเมล</label>
          <input id="login-email" type="email" placeholder="your@email.com">
        </div>
        <div class="form-group">
          <label for="login-password">รหัสผ่าน</label>
          <input id="login-password" type="password" placeholder="รหัสผ่าน">
        </div>
        <button id="login-btn" class="btn btn-primary">
          เข้าสู่ระบบ
        </button>
      </div>

      <!-- Register -->
      <div>
        <div class="section-title">ลงทะเบียนผู้ใช้ใหม่</div>
        <div class="section-hint">
          สร้างบัญชีใหม่ เพื่อบันทึกและดูสถิติผลผลิตของฟาร์มของคุณ
        </div>

        <div class="form-group">
          <label for="reg-fullname">ชื่อ–สกุล</label>
          <input id="reg-fullname" type="text" placeholder="ชื่อ–สกุล">
        </div>

        <div class="form-group">
          <label for="reg-username">ชื่อผู้ใช้ (ใช้แสดงผล)</label>
          <input id="reg-username" type="text" placeholder="เช่น farmer surin">
        </div>

        <div class="form-group">
          <label for="reg-farm-name">ชื่อฟาร์ม / กลุ่มเกษตรกร</label>
          <input id="reg-farm-name" type="text" placeholder="เช่น กลุ่มเกษตรกรไหมบ้านตาโป">
        </div>

        <div class="form-group">
          <label for="reg-email">อีเมล (ใช้เข้าสู่ระบบ)</label>
          <input id="reg-email" type="email" placeholder="your@email.com">
        </div>

        <div class="form-group">
          <label for="reg-password">รหัสผ่าน</label>
          <input id="reg-password" type="password" placeholder="รหัสผ่านอย่างน้อย 6 ตัวอักษร">
        </div>

        <div class="text-right">
          <button id="register-btn" class="btn btn-outline">
            ลงทะเบียน
          </button>
        </div>
      </div>
    </div>

    <div id="auth-message" class="status-bar status-info">
      กรุณาเข้าสู่ระบบเพื่อดูแดชบอร์ดผลผลิตไหมเลี้ยง
    </div>
  </section>

  <!-- 2) DASHBOARD SECTION -->
  <section id="dashboard-section" class="card hidden">
    <div class="card-header-row">
      <div>
        <div class="card-title">แดชบอร์ดผลผลิตไหมเลี้ยง</div>
        <div class="card-subtitle">
          สรุปข้อมูลการเลี้ยงไหมจากฐานข้อมูล Supabase – ตารางและกราฟ
        </div>
      </div>
      <div style="display:flex; flex-wrap:wrap; gap:8px; align-items:center;">
        <div class="badge-user" id="dashboard-user-badge">
          ผู้ใช้: -
        </div>
        <button id="logout-btn-dashboard" class="btn btn-danger btn-sm">
          ออกจากระบบ
        </button>
      </div>
    </div>

    <div id="dashboard-status" class="status-bar status-info">
      เข้าสู่ระบบสำเร็จ แต่ยังไม่มีข้อมูลรอบการเลี้ยงไหมในระบบ
    </div>

    <div class="dashboard-grid">
      <!-- ตาราง/ข้อมูล -->
      <div>
        <div class="stat-grid">
          <div class="stat-card">
            <div class="stat-label">จำนวนรอบการเลี้ยงทั้งหมด</div>
            <div class="stat-value" id="stat-total-cycles">0</div>
            <div class="stat-unit">บันทึกจากตาราง silkworm_cycles</div>
          </div>
          <div class="stat-card">
            <div class="stat-label">จำนวนแผ่นไข่รวม</div>
            <div class="stat-value" id="stat-total-eggs">0</div>
            <div class="stat-unit">แผ่นไข่ทั้งหมดในทุก ๆ รอบ</div>
          </div>
          <div class="stat-card">
            <div class="stat-label">น้ำหนักรังไหมรวม</div>
            <div class="stat-value" id="stat-total-cocoon">0.00</div>
            <div class="stat-unit">กิโลกรัมของรังไหมทั้งหมด</div>
          </div>
          <div class="stat-card">
            <div class="stat-label">น้ำหนักเส้นไหมรวม</div>
            <div class="stat-value" id="stat-total-silk">0.00</div>
            <div class="stat-unit">กิโลกรัมของเส้นไหมที่สาวได้</div>
          </div>
        </div>

        <div class="table-wrapper">
          <table>
            <thead>
            <tr>
              <th>รอบการเลี้ยง</th>
              <th>เริ่ม–สิ้นสุด</th>
              <th>พันธุ์ไหม</th>
              <th>แผ่นไข่</th>
              <th>รังไหม (กก.)</th>
              <th>เส้นไหม (กก.)</th>
              <th>หมายเหตุ</th>
            </tr>
            </thead>
            <tbody id="cycles-table-body">
            <tr>
              <td class="empty-row" colspan="7">
                ยังไม่มีข้อมูลรอบการเลี้ยงไหมในระบบ กรุณาบันทึกผ่าน Supabase หรือฟอร์มในอนาคต
              </td>
            </tr>
            </tbody>
          </table>
        </div>
      </div>

      <!-- กราฟ -->
      <div>
        <div class="chart-box">
          <div class="chart-header">
            <div class="chart-title">กราฟผลผลิต</div>
            <div class="chart-subtitle">Timeline &amp; พันธุ์ไหม</div>
          </div>
          <canvas id="silk-chart"></canvas>
        </div>
      </div>
    </div>
  </section>
</div>

<script>
  // ==============================
  // 1. ตั้งค่า Supabase
  // ==============================
  const SUPABASE_URL = 'YOUR_SUPABASE_URL';
  const SUPABASE_ANON_KEY = 'YOUR_SUPABASE_ANON_KEY';

  const supabaseClient = window.supabase.createClient(SUPABASE_URL, SUPABASE_ANON_KEY);

  // อ้างอิง element
  const authSection = document.getElementById('auth-section');
  const dashboardSection = document.getElementById('dashboard-section');

  const authMessageEl = document.getElementById('auth-message');
  const dashboardStatusEl = document.getElementById('dashboard-status');

  const loginBtn = document.getElementById('login-btn');
  const registerBtn = document.getElementById('register-btn');
  const logoutDashBtn = document.getElementById('logout-btn-dashboard');

  const dashboardUserBadge = document.getElementById('dashboard-user-badge');

  let currentUser = null;
  let silkChartInstance = null;

  function showAuth() {
    authSection.classList.remove('hidden');
    dashboardSection.classList.add('hidden');
  }

  function showDashboard() {
    authSection.classList.add('hidden');
    dashboardSection.classList.remove('hidden');
    loadDashboardData();
  }

  function setAuthMessage(type, text) {
    authMessageEl.textContent = text;
    authMessageEl.classList.remove('status-info','status-success','status-error');
    authMessageEl.classList.add(
      type === 'error' ? 'status-error' :
      type === 'success' ? 'status-success' : 'status-info'
    );
  }

  function setDashboardStatus(type, text) {
    dashboardStatusEl.textContent = text;
    dashboardStatusEl.classList.remove('status-info','status-success','status-error');
    dashboardStatusEl.classList.add(
      type === 'error' ? 'status-error' :
      type === 'success' ? 'status-success' : 'status-info'
    );
  }

  function updateUserBadge(email) {
    dashboardUserBadge.textContent = 'ผู้ใช้: ' + email;
  }

  // ==============================
  // 2. ตรวจ session ตอนโหลดหน้า
  // ==============================
  document.addEventListener('DOMContentLoaded', async () => {
    const { data, error } = await supabaseClient.auth.getSession();
    if (error) {
      console.error(error);
      showAuth();
      return;
    }
    if (data.session && data.session.user) {
      currentUser = data.session.user;
      updateUserBadge(currentUser.email);
      setDashboardStatus('info','เข้าสู่ระบบสำเร็จ ระบบจะดึงข้อมูลรอบการเลี้ยงไหมจากฐานข้อมูล');
      showDashboard();
    } else {
      showAuth();
    }
  });

  // ==============================
  // 3. ลงทะเบียน
  // ==============================
  registerBtn.addEventListener('click', async () => {
    const fullName = document.getElementById('reg-fullname').value.trim();
    const username = document.getElementById('reg-username').value.trim();
    const farmName = document.getElementById('reg-farm-name').value.trim();
    const email = document.getElementById('reg-email').value.trim();
    const password = document.getElementById('reg-password').value;

    if (!fullName || !username || !farmName || !email || !password) {
      setAuthMessage('error','กรุณากรอกข้อมูลให้ครบถ้วนก่อนลงทะเบียน');
      return;
    }
    if (password.length < 6) {
      setAuthMessage('error','รหัสผ่านต้องมีอย่างน้อย 6 ตัวอักษร');
      return;
    }

    setAuthMessage('info','กำลังลงทะเบียนผู้ใช้ใหม่...');

    const { data, error } = await supabaseClient.auth.signUp({ email, password });
    if (error) {
      console.error(error);
      setAuthMessage('error','ไม่สามารถลงทะเบียนได้: ' + error.message);
      return;
    }

    const user = data.user;
    if (!user) {
      setAuthMessage('error','ลงทะเบียนสำเร็จแล้ว แต่ไม่พบข้อมูลผู้ใช้จาก Supabase กรุณาลองเข้าสู่ระบบอีกครั้ง');
      return;
    }

    const { error: profileError } = await supabaseClient
      .from('profiles')
      .insert({
        user_id:user.id,
        full_name:fullName,
        username:username,
        farm_name:farmName
      });

    if (profileError) {
      console.error(profileError);
      setAuthMessage('error','ลงทะเบียนสำเร็จ แต่ไม่สามารถสร้างโปรไฟล์ได้: ' + profileError.message);
      return;
    }

    currentUser = user;
    updateUserBadge(user.email);
    setAuthMessage('success','ลงทะเบียนและสร้างโปรไฟล์สำเร็จแล้ว กรุณาเข้าสู่ระบบด้วยอีเมลและรหัสผ่านของคุณ');
  });

  // ==============================
  // 4. เข้าสู่ระบบ
  // ==============================
  loginBtn.addEventListener('click', async () => {
    const email = document.getElementById('login-email').value.trim();
    const password = document.getElementById('login-password').value;

    if (!email || !password) {
      setAuthMessage('error','กรุณากรอกอีเมลและรหัสผ่าน');
      return;
    }

    setAuthMessage('info','กำลังเข้าสู่ระบบ...');

    const { data, error } = await supabaseClient.auth.signInWithPassword({
      email,
      password
    });

    if (error) {
      console.error(error);
      // ตรงนี้คือกรณี username / password ไม่ถูกต้อง
      setAuthMessage('error','เข้าสู่ระบบไม่สำเร็จ: ชื่อผู้ใช้หรือรหัสผ่านไม่ถูกต้อง กรุณาลองใหม่');
      return;
    }

    currentUser = data.user;
    updateUserBadge(currentUser.email);
    setAuthMessage('success','เข้าสู่ระบบสำเร็จ กำลังพาไปยังแดชบอร์ด...');
    setDashboardStatus('info','กำลังดึงข้อมูลรอบการเลี้ยงไหมจากฐานข้อมูล');
    showDashboard();
  });

  // ==============================
  // 5. Logout
  // ==============================
  async function handleLogout() {
    await supabaseClient.auth.signOut();
    currentUser = null;
    setAuthMessage('info','ออกจากระบบเรียบร้อย');
    showAuth();
  }
  logoutDashBtn.addEventListener('click', handleLogout);

  // ==============================
  // 6. โหลดข้อมูล Dashboard จาก Supabase
  // ==============================
  async function loadDashboardData() {
    if (!currentUser) return;

    const { data, error } = await supabaseClient
      .from('silkworm_cycles')
      .select('*')
      .eq('user_id', currentUser.id)
      .order('start_date', { ascending:true });

    if (error) {
      console.error(error);
      setDashboardStatus('error','ไม่สามารถดึงข้อมูลรอบการเลี้ยงไหมได้: ' + error.message);
      return;
    }

    const cycles = data || [];

    const totalCycles = cycles.length;
    const totalEggs = cycles.reduce((s,c)=> s + (c.egg_tray_count || 0), 0);
    const totalCocoon = cycles.reduce((s,c)=> s + Number(c.cocoon_weight_kg || 0), 0);
    const totalSilk = cycles.reduce((s,c)=> s + Number(c.raw_silk_weight_kg || 0), 0);

    document.getElementById('stat-total-cycles').textContent = totalCycles;
    document.getElementById('stat-total-eggs').textContent = totalEggs;
    document.getElementById('stat-total-cocoon').textContent = totalCocoon.toFixed(2);
    document.getElementById('stat-total-silk').textContent = totalSilk.toFixed(2);

    const tbody = document.getElementById('cycles-table-body');
    tbody.innerHTML = '';

    if (cycles.length === 0) {
      const tr = document.createElement('tr');
      const td = document.createElement('td');
      td.colSpan = 7;
      td.className = 'empty-row';
      td.textContent = 'ยังไม่มีข้อมูลรอบการเลี้ยงไหมในระบบ กรุณาบันทึกผ่าน Supabase หรือฟอร์มในอนาคต';
      tr.appendChild(td);
      tbody.appendChild(tr);
      setDashboardStatus('info','เข้าสู่ระบบสำเร็จ แต่ยังไม่มีข้อมูลรอบการเลี้ยงไหมในระบบ');
    } else {
      for (const cycle of cycles) {
        const tr = document.createElement('tr');

        const periodText = (cycle.start_date || '') +
          (cycle.end_date ? ' – ' + cycle.end_date : '');

        const cells = [
          cycle.cycle_name || '-',
          periodText || '-',
          cycle.silkworm_breed || '-',
          cycle.egg_tray_count ?? '-',
          cycle.cocoon_weight_kg ?? '-',
          cycle.raw_silk_weight_kg ?? '-',
          cycle.note || '-'
        ];

        for (const value of cells) {
          const td = document.createElement('td');
          td.textContent = value;
          tr.appendChild(td);
        }
        tbody.appendChild(tr);
      }

      setDashboardStatus('success','ดึงข้อมูลรอบการเลี้ยงไหมสำเร็จแล้ว แสดงผลในตารางและกราฟด้านล่าง');
    }

    // อัปเดตกราฟ
    const labels = cycles.map(c => c.cycle_name || 'รอบ');
    const cocoonData = cycles.map(c => Number(c.cocoon_weight_kg || 0));
    const silkData   = cycles.map(c => Number(c.raw_silk_weight_kg || 0));

    const ctx = document.getElementById('silk-chart').getContext('2d');
    if (silkChartInstance) silkChartInstance.destroy();

    silkChartInstance = new Chart(ctx, {
      type:'bar',
      data:{
        labels,
        datasets:[
          { label:'รังไหม (กก.)', data:cocoonData },
          { label:'เส้นไหม (กก.)', data:silkData }
        ]
      },
      options:{
        responsive:true,
        maintainAspectRatio:false,
        plugins:{
          legend:{ labels:{ font:{ family:'Sarabun', size:14 } } }
        },
        scales:{
          x:{ ticks:{ font:{ family:'Sarabun', size:13 } } },
          y:{ beginAtZero:true, ticks:{ font:{ family:'Sarabun', size:13 } } }
        }
      }
    });
  }
</script>
</body>
</html>
