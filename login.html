<script type="module">
  import { createClient } from "https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2/+esm";

  // 1) ตั้งค่า Supabase ของคุณ
  const SUPABASE_URL = "https://dpgnqrxanxyxhibkfspx.supabase.co";
  const SUPABASE_ANON_KEY = "eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6ImRwZ25xcnhhbnh5eGhpYmtmc3B4Iiwicm9sZSI6ImFub24iLCJpYXQiOjE3NjMwMjU5NjksImV4cCI6MjA3ODYwMTk2OX0.CTWYu4ZxS_gW6G4r0zGNNj6gVkNE6jSWmcGoXc6GaxI";
  const supabase = createClient(SUPABASE_URL, SUPABASE_ANON_KEY);

  const form = document.getElementById("login-form");
  const usernameInput = document.getElementById("username");
  const passwordInput = document.getElementById("password");
  const errorText = document.getElementById("error-text");

  form.addEventListener("submit", async (e) => {
    e.preventDefault();
    errorText.textContent = "";

    const username = usernameInput.value.trim();
    const password = passwordInput.value;

    if (!username || !password) {
      errorText.textContent = "กรุณากรอกชื่อผู้ใช้และรหัสผ่านให้ครบถ้วน";
      return;
    }

    try {
      // 2) หา email จากตาราง profiles ด้วย username
      const { data: profile, error: profileError } = await supabase
        .from("profiles")
        .select("email")
        .eq("username", username)
        .single();

      if (profileError || !profile || !profile.email) {
        errorText.textContent = "ชื่อผู้ใช้ไม่ถูกต้องหรือไม่มีอยู่ในระบบ";
        return;
      }

      // 3) ล็อกอินด้วย email + password ผ่าน Supabase Auth
      const { data, error: loginError } = await supabase.auth.signInWithPassword({
        email: profile.email,
        password,
      });

      if (loginError) {
        console.error(loginError);
        errorText.textContent = "รหัสผ่านไม่ถูกต้อง";
        return;
      }

      // 4) ล็อกอินสำเร็จ → ไปหน้า Dashboard
      window.location.href = "dashboard.html";
    } catch (err) {
      console.error(err);
      errorText.textContent = "เกิดข้อผิดพลาดในการเชื่อมต่อระบบ กรุณาลองใหม่อีกครั้ง";
    }
  });
</script>
